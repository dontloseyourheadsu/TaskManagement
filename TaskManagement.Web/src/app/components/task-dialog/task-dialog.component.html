<h2 mat-dialog-title>
  {{ data.mode === "create" ? "Create Task" : "Edit Task" }}
</h2>

<mat-dialog-content>
  <form [formGroup]="taskForm" class="task-form">
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Title *</mat-label>
      <input matInput formControlName="title" placeholder="Enter task title" />
      @if (taskForm.get('title')?.hasError('required')) {
        <mat-error>
          Title is required
        </mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Description</mat-label>
      <textarea
        matInput
        formControlName="description"
        rows="3"
        placeholder="Enter task description"
      ></textarea>
    </mat-form-field>

    <div class="time-row">
      <mat-form-field appearance="outline">
        <mat-label>Start Date</mat-label>
        <input
          matInput
          [matDatepicker]="startDatePicker"
          formControlName="startDate"
        />
        <mat-datepicker-toggle
          matSuffix
          [for]="startDatePicker"
        ></mat-datepicker-toggle>
        <mat-datepicker #startDatePicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Start Time</mat-label>
        <input matInput type="time" formControlName="startTime" />
      </mat-form-field>
    </div>

    <div class="time-row">
      <mat-form-field appearance="outline">
        <mat-label>End Date</mat-label>
        <input
          matInput
          [matDatepicker]="endDatePicker"
          formControlName="endDate"
        />
        <mat-datepicker-toggle
          matSuffix
          [for]="endDatePicker"
        ></mat-datepicker-toggle>
        <mat-datepicker #endDatePicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>End Time</mat-label>
        <input matInput type="time" formControlName="endTime" />
      </mat-form-field>
    </div>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Type</mat-label>
      <mat-select formControlName="type">
        @for (type of taskTypes; track type.value) {
          <mat-option [value]="type.value">
            {{ type.label }}
          </mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Topic</mat-label>
      <mat-select formControlName="topicId">
        @for (topic of topics; track topic.id) {
          <mat-option [value]="topic.id">
            {{ topic.name }}
          </mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Color</mat-label>
      <mat-select formControlName="color">
        @for (color of colorOptions; track color.value) {
          <mat-option [value]="color.value">
            <div class="color-option">
              <div
                class="color-preview"
                [style.background-color]="color.value"
              ></div>
              {{ color.label }}
            </div>
          </mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Due Date</mat-label>
      <input
        matInput
        [matDatepicker]="dueDatePicker"
        formControlName="dueDate"
      />
      <mat-datepicker-toggle
        matSuffix
        [for]="dueDatePicker"
      ></mat-datepicker-toggle>
      <mat-datepicker #dueDatePicker></mat-datepicker>
    </mat-form-field>

    <div class="checkbox-row">
      <mat-checkbox formControlName="urgent" class="checkbox-item">
        Mark as urgent
      </mat-checkbox>

      <mat-checkbox formControlName="completed" class="checkbox-item">
        Mark as completed
      </mat-checkbox>
    </div>

    <!-- Substeps Section (only show for existing tasks) -->
    @if (data.mode === 'edit' && data.task && 'id' in data.task) {
      <div class="substeps-section">
        <h3 class="substeps-title">
          <mat-icon>checklist</mat-icon>
          Substeps
        </h3>

        <!-- Existing substeps -->
        @if (substeps.length > 0) {
          <div class="substeps-list">
            @for (substep of substeps; track trackBySubstep($index, substep)) {
              <div class="substep-item">
                <mat-checkbox
                  [checked]="substep.completed"
                  (change)="toggleSubstepCompleted(substep)"
                  class="substep-checkbox"
                >
                  {{ substep.description }}
                </mat-checkbox>
                <button
                  type="button"
                  mat-icon-button
                  color="warn"
                  (click)="deleteSubstep(substep.id)"
                  class="delete-substep-btn"
                  matTooltip="Delete substep"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            }
          </div>
        }

        <!-- Add new substep -->
        <div class="add-substep-row">
          <mat-form-field appearance="outline" class="substep-input">
            <mat-label>Add substep</mat-label>
            <input
              matInput
              [(ngModel)]="newSubstepDescription"
              [ngModelOptions]="{ standalone: true }"
              (ngModelChange)="onSubstepDescriptionChange($event)"
              (keyup.enter)="addSubstep()"
              placeholder="Enter substep description"
            />
          </mat-form-field>
          <button
            type="button"
            mat-icon-button
            color="primary"
            (click)="addSubstep()"
            [disabled]="isAddSubstepDisabled"
            matTooltip="Add substep"
          >
            <mat-icon>add</mat-icon>
          </button>
        </div>

        <!-- Loading indicator -->
        @if (isLoadingSubsteps) {
          <div class="loading-substeps">
            <mat-icon>hourglass_empty</mat-icon>
            Loading substeps...
          </div>
        }

        <!-- Empty state -->
        @if (!isLoadingSubsteps && substeps.length === 0) {
          <div class="empty-substeps">
            <mat-icon>assignment_turned_in</mat-icon>
            <p>No substeps yet. Add one above to break down this task.</p>
          </div>
        }
      </div>
    }
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()">Cancel</button>
  <button
    mat-raised-button
    color="primary"
    [disabled]="!taskForm.valid"
    (click)="onSave()"
  >
    {{ data.mode === "create" ? "Create" : "Update" }}
  </button>
</mat-dialog-actions>
